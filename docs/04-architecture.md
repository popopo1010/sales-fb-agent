# アーキテクチャ設計

## 1. システム構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                        営業FBエージェントシステム                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │   入力層      │    │  処理層       │    │      出力層           │  │
│  │              │    │              │    │                      │  │
│  │ 書き起こし   │───▶│ FB生成       │───▶│ Slack API            │  │
│  │ (txt/md)     │    │ エージェント  │    │ (チャンネル/DM)       │  │
│  └──────────────┘    └──────┬───────┘    └──────────────────────┘  │
│         │                   │ 参照                    ▲             │
│         │                   ▼                        │             │
│  ┌──────┴──────┐   ┌──────────────────────────────┐   │             │
│  │ Slack /fb   │   │  参照層                      │   │             │
│  │ (モーダル)   │──▶│  reference/pss/             │───┘             │
│  └─────────────┘   │  reference/operations/       │                 │
│                    └──────────────────────────────┘                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ API呼び出し
                                    ▼
                         ┌──────────────────┐
                         │  LLM API         │
                         │  (OpenAI/Claude等)│
                         └──────────────────┘
```

### 入力経路

| 経路 | 入口 | 用途 |
|------|------|------|
| CLI | `python src/main.py ファイル` | ファイル指定でFB生成 |
| Slack | `/fb` スラッシュコマンド | モーダルで書き起こし入力→#dk_ca_fb に投稿 |

## 2. コンポーネント設計

### 2.1 入力コンポーネント

| コンポーネント | 責務 | 技術 |
|----------------|------|------|
| ファイル読み込み | 書き起こしテキストを取得 | ローカルファイル I/O |
| パース | 形式に応じた正規化 | 正規表現 / 簡易パーサー |

### 2.2 処理コンポーネント

| コンポーネント | 責務 | 技術 |
|----------------|------|------|
| 参照ドキュメントローダー | PSS・オペレーションマニュアルを読み込み | ファイル I/O |
| プロンプト構築 | 書き起こし + 参照を組み合わせてプロンプト生成 | テンプレート |
| FB生成エージェント | LLMにプロンプトを送り、FBを得る | OpenAI API / Anthropic API 等 |
| 出力整形 | FBをSlack用にフォーマット | Markdown → Slack mrkdwn |

### 2.3 出力コンポーネント

| コンポーネント | 責務 | 技術 |
|----------------|------|------|
| Slack送信 | `chat.postMessage` でFBを投稿 | Slack Web API |

### 2.4 参照ドキュメント（データ）

| パス | 役割 |
|------|------|
| `reference/pss/` | PSS営業スキーム（評価基準・フロー・チェック項目） |
| `reference/operations/` | オペレーションマニュアル（手順・ルール） |

## 3. データフロー

```
[書き起こし] ──▶ [テキスト読み込み]
                        │
                        ▼
[reference/pss/] ──▶ [プロンプト構築] ◀── [reference/operations/]
[config/prompts/]         │
                        ▼
                  [LLM API]
                        │
                        ▼
                  [FBテキスト]
                        │
                        ▼
                  [Slack API] ──▶ [Slackチャンネル]
```

## 4. 技術スタック

| 層 | 技術 |
|----|------|
| 実行環境 | Python 3.10+（推奨 3.11） |
| LLM | OpenAI GPT-4 / Anthropic Claude |
| Slack | slack-sdk, slack-bolt (Python) |
| 設定 | .env (python-dotenv) |
| 実行方式 | CLI / Slack /fb スラッシュコマンド |
| デプロイ | ローカル / Railway / Xserver 等 |

## 5. セキュリティ考慮

- APIキー・Slackトークンは環境変数で管理
- 書き起こしはローカル処理のみ（外部永続化しない場合は memory に保存しない）
- 参照ドキュメントはリポジトリ内で管理（機密の場合は .gitignore で除外可能）

## 6. 拡張性

- プロンプト追加や変更でFBの内容・形式を調整可能
- 別チャンネル・別ワークスペースへの送信は設定変更で対応
- Slack /fb は Socket Mode で接続。Railway / Fly.io 等にデプロイ可能
- 将来的に Web UI を追加する場合は、API 層を分離する設計を推奨
